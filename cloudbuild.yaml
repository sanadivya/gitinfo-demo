substitutions:
  _ENV: dev
  _PROJECT_ID: articulate-area-464808-q4
  _SERVICE_NAME: gitinfo-demo
  _REGION: europe-west1
  _REPO: gitinfo-demo
  _REVISION_ID: "${REVISION_ID}"
  _SERVICE_ACCOUNT: 715553450089-compute@developer.gserviceaccount.com

options:
  logging: CLOUD_LOGGING_ONLY

available_secrets:
  secretManager:
    - versionName: projects/${_PROJECT_ID}/secrets/GITHUB_TOKEN/versions/latest
      env: GITHUB_TOKEN
    - versionName: projects/${_PROJECT_ID}/secrets/TEAMS_WEBHOOK_URL/versions/latest
      env: TEAMS_WEBHOOK_URL
    - versionName: projects/${_PROJECT_ID}/secrets/TEAMS_WEBHOOK_FAILURE_URL/versions/latest
      env: TEAMS_WEBHOOK_FAILURE_URL

steps:
  
  - id: Build
    allowFailure: true
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "ðŸ”§ Simulating build..."
        if ! docker build -t "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_SERVICE_NAME}:$SHORT_SHA" .; then
          echo "Build failed" > /workspace/failure_marker
        fi

  - id: Push
    allowFailure: true
    waitFor: ["Build"]
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "ðŸ“¦ Pushing image..."
        if ! docker push "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_SERVICE_NAME}:$SHORT_SHA"; then
          echo "Push failed" > /workspace/failure_marker
        fi

  - id: Deploy
    allowFailure: true
    waitFor: ["Push"]
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "ðŸš€ Starting deployment..."
        if ! gcloud run deploy "${_SERVICE_NAME}" \
          --image="${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_SERVICE_NAME}:$SHORT_SHA" \
          --region="${_REGION}" \
          --allow-unauthenticated \
          --service-account="${_SERVICE_ACCOUNT}" \
          --set-secrets="TEAMS_WEBHOOK_URL=TEAMS_WEBHOOK_URL:latest" \
          --set-secrets="TEAMS_WEBHOOK_FAILURE_URL=TEAMS_WEBHOOK_FAILURE_URL:latest" \
          --set-secrets="GITHUB_TOKEN=GITHUB_TOKEN:latest"; then
          echo "Deploy failed" > /workspace/failure_marker
        fi

  - name: 'gcr.io/cloud-builders/git'
    id: Get-PR-Details
    secretEnv: ['GITHUB_TOKEN']
    entrypoint: bash
    args:
      - -c
      - |
        set -e

        apt-get update && apt-get install -y jq curl

        echo "Fetching PR details for commit: $REVISION_ID"
        echo "${_REVISION_ID}"

        PR_DATA=$(curl -s -H "Authorization: token $$GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.groot-preview+json" \
          "https://api.github.com/repos/sanadivya/gitinfo-demo/commits/$REVISION_ID/pulls")

        PR_NUMBER=$(echo "$$PR_DATA" | jq -r '.[0].number')
        PR_TITLE=$(echo "$$PR_DATA" | jq -r '.[0].title')
        PR_USER=$(echo "$$PR_DATA" | jq -r '.[0].user.login')
        PR_URL=$(echo "$$PR_DATA" | jq -r '.[0].html_url')

        echo "PR_NUMBER=$PR_NUMBER" >> /workspace/pr_info.env
        echo "PR_TITLE=$PR_TITLE" >> /workspace/pr_info.env
        echo "PR_USER=$PR_USER" >> /workspace/pr_info.env
        echo "PR_URL=$PR_URL" >> /workspace/pr_info.env


  - name: 'gcr.io/cloud-builders/curl'
    id: Notify
    waitFor: ["Build", "Push", "Deploy", "Get-PR-Details"]
    allowFailure: true
    env:
      - $(cat /workspace/pr_info.env)
    secretEnv: ['GITHUB_TOKEN', 'TEAMS_WEBHOOK_URL', 'TEAMS_WEBHOOK_FAILURE_URL']
    args:
      [
        "-H", "Content-Type: application/json",
        "-d", "{
          \"@type\": \"MessageCard\",
          \"@context\": \"http://schema.org/extensions\",
          \"themeColor\": \"0076D7\",
          \"summary\": \"Cloud Build Notification\",
          \"sections\": [{
            \"activityTitle\": \"âœ… Deployment Successful\",
            \"text\": \"### ðŸ“Œ Deployment Details\",   
            \"facts\": [
              {\"name\": \"Service\", \"value\": \"${_SERVICE_NAME}\"},
              {\"name\": \"Project\", \"value\": \"${_PROJECT_ID}\"},
              {\"name\": \"Version\", \"value\": \"$SHORT_SHA\"},
              {\"name\": \"Environment\", \"value\": \"${_ENV}\"},
              {\"name\": \"PR #\", \"value\": \"$$PR_NUMBER\"},
              {\"name\": \"Title\", \"value\": \"$$PR_TITLE\"},
              {\"name\": \"Author\", \"value\": \"$$PR_USER\"},
              {\"name\": \"Link\", \"value\": \"$$PR_URL\"}
            ],
            \"markdown\": true
          }]
        }",
        "https://pakompetens.webhook.office.com/webhookb2/3b361490-df1e-4317-91e4-c3aec626287f@fdb820d5-bcd4-43fc-ac72-c1638a72ae9c/IncomingWebhook/09fd98c09d6b4b26a21c1a22bc2c02e7/da953398-22b5-4e5d-b7c2-1ae89b32899e/V2mNV7H_or53WYxH5WJ0zZ97U62fWP-I_r_iWR3ox9k781"
      ]
